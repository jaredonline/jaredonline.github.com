
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Sprockets 2 with Rails 2.3 - Jared McFarland</title>
  <meta name="author" content="Jared McFarland">

  
  <meta name="description" content="At FutureAdvisor our main app is still in Rails 2.3, mainly because upgrading to Rails 3 is kind of a pain. I generally keep a few side projects &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jaredonline.github.com/blog/2012/05/16/sprockets-2-with-rails-2-dot-3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Jared McFarland" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-7432948-5']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="no-sidebar"  >
  <header role="banner"><hgroup>
  <h1><a href="/">Jared McFarland</a></h1>
  
    <h2>The musings of a 20-something engineer</h2>
  
</hgroup>

</header>
  <nav role="navigation">
  
<ul class="main-navigation">
  <li><a href="/about">About</a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Sprockets 2 With Rails 2.3</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-16T10:33:00-07:00" pubdate data-updated="true">May 16<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>
  At
  <a href='http://www.futureadvisor.com'>FutureAdvisor</a>
  our main app is still in Rails 2.3, mainly because
  upgrading to Rails 3 is kind of a pain.  I generally keep a few side projects
  around, like
  <a href='http://www.myroommateapp.com'>MyRoommate,</a>
  to play around with new technologies.  I&#8217;ve upgraded MyRoommate to use Rails 3.2 and
  am absolutely in love with the Asset Pipeline.  So I set out to make it work with our
  Rails 2.3 app at FutureAdvisor.
</p>
<p>
  Here&#8217;s what I&#8217;ll cover:
</p>
<ol>
  <li>
    Installing
    <a href='https://github.com/sstephenson/sprockets'>Sprockets</a>
    and mounting the Rack app
  </li>
  <li>
    Overriding Rails
    <code>AssetTagHelper</code>
    to be aware of Sprockets specific pathing
  </li>
  <li>Precompiling assets for use in production (and Sprockets manifest files).</li>
</ol>
<!-- more -->
<p>
  Obviously, the first step was Google.  I came across
  <a href='http://stackoverflow.com/questions/10404380/sprockets-2-with-rails-2-3' target='_blank'>this question on StackOverflow</a>
  which mentioned
  <a href='http://pivotallabs.com/users/dwfrank/blog/articles/1972-giving-rails-2-the-asset-pipeline-' target='_blank'>this blog from PivotalLabs.</a>
</p>
<p>
  The blog was a bit dated, from December of last year, and it didn&#8217;t work quite right.  The first steps were spot on though.
</p>
<p>
  Install the gems (hopefully you&#8217;re using Bundler):
</p>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Gemfile</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;sprockets&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 2.0&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># My setup uses SASS, HAML and CoffeeScript, but you can obviously use substitutes</span>
</span><span class='line'><span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;sass&#39;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;haml&#39;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;coffee-script&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;sprockets-sass&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># Command line; root of your app</span>
</span><span class='line'>bundle install
</span></code></pre></td></tr></table></div></figure>
<p>
  This is where my instructions diverge from those of the fine folks at PivotalLabs.  You&#8217;ll have to create a
  <code>Sprockets::Environment</code>
  for use in several places.  The first place is with Rack.  Sprockets creates a Rack middleware app that
  will respond to requests at
  <code>/assets</code>
  with the proper compiled file. I like to store the
  <code>Sprockets::Environment</code>
  in an initialize so it&#8217;s available throughout my app.
</p>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># config/initializers/sprockets.rb</span>
</span><span class='line'><span class="k">module</span> <span class="nn">Sprockets</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">env</span>
</span><span class='line'>    <span class="n">sprockets</span> <span class="o">=</span> <span class="no">Sprockets</span><span class="o">::</span><span class="no">Environment</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="n">sprockets</span><span class="o">.</span><span class="n">append_path</span> <span class="s1">&#39;app/assets/javascripts&#39;</span>
</span><span class='line'>    <span class="n">sprockets</span><span class="o">.</span><span class="n">append_path</span> <span class="s1">&#39;app/assets/stylesheets&#39;</span>
</span><span class='line'>    <span class="n">sprockets</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">manifest</span>
</span><span class='line'>    <span class="no">Sprockets</span><span class="o">::</span><span class="no">Manifest</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;public&quot;</span><span class="p">,</span> <span class="s2">&quot;assets&quot;</span><span class="p">,</span> <span class="s2">&quot;manifest.json&quot;</span><span class="p">))</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>
<p>
  Now I can refer to
  <code>Sprockets.env</code>
  wherever I need the
  <code>Sprockets::Environment</code>
  with the appropriate configuration.  We&#8217;ll go into more detail about the
  <code>Sprockets.manifest</code>
  method in a little bit.
</p>
<p>
  In your Rack middleware file (
  <code>config.ru</code>
  if you don&#8217;t have it, just make it and place it in the root
  directory of your app), add the following:
</p>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># config.ru</span>
</span><span class='line'><span class="c1"># we need to protect against multiple includes of the Rails environment (trust me)</span>
</span><span class='line'><span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/config/environment&#39;</span> <span class="k">if</span> <span class="o">!</span><span class="n">defined?</span><span class="p">(</span><span class="no">Rails</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="no">Rails</span><span class="o">.</span><span class="n">initialized?</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;sprockets&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">unless</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">production?</span>
</span><span class='line'>  <span class="n">map</span> <span class="s1">&#39;/assets&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">sprockets</span> <span class="o">=</span> <span class="no">Sprockets</span><span class="o">.</span><span class="n">env</span>
</span><span class='line'>    <span class="n">run</span> <span class="n">sprockets</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">map</span> <span class="s1">&#39;/&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">run</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Dispatcher</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>
<p>
  Notice how we only mount this app if we&#8217;re not in
  production? This is because we want to avoid compiling assets on the fly
  in our production environment.  We&#8217;d rather precompile all assets, and then
  serve them statically.  More on that later.  First, let&#8217;s setup your
  asset directories.
</p>
<p>
  Sprockets is going to look for your assets in the
  <code>/app/assets</code>
  directory, so we need to create those now.
</p>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># Command line; root of your app</span>
</span><span class='line'>mkdir app/assets
</span><span class='line'>mkdir app/assets/javascripts
</span><span class='line'>mkdir app/assets/stylesheets
</span></code></pre></td></tr></table></div></figure>
<p>
  Now you need to move all your assets from your
  <code>/public</code>
  directory to your
  <code>/app/assets</code>
  directories so Sprockets can find them
</p>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># Command line; root of your app</span>
</span><span class='line'>mv public/stylesheets/* app/assets/stylesheets/
</span><span class='line'>mv public/javascripts/* app/assets/javascripts/
</span></code></pre></td></tr></table></div></figure>
<p>
  If you have a stylesheet named
  <code>application.css</code>
  you should now be able to browse to
  <code>http://localhost:3000/assets/application.css</code>
  and see your stylesheet.
</p>
<p>
  At this point, you&#8217;ve got Sprockets mounted, and it&#8217;ll automagically
  interpret your SASS, HAML and CoffeeScript files, but all your helpers
  like
  <code>javascript_include_tag</code>
  and
  <code>stylesheet_link_tag</code>
  don&#8217;t work anymore.  Fortunately, we can fix that.
</p>
<p>
  When overriding Rails functionality, I like to put all my overrides in a single
  place,
  <code>/lib/extensions</code>
  so I know where they are.  The file tree (for this particular override)
  usually looks something like this:
</p>
<pre>lib&#x000A; |&#x000A;  - extenstions/&#x000A;     |&#x000A;      - action_view/&#x000A;         |&#x000A;          - helpers/&#x000A;             |&#x000A;              - asset_tag_helper.rb&#x000A;          - helpers.rb&#x000A;      - action_view.rb&#x000A;  - extensions.rb&#x000A;</pre>
<p>
  It might be a little bit of overkill just for this one override, but it helps in the
  long run if you plan on adding more overrides or extensions in the future.  Here&#8217;s the
  contents of each file:
</p>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># extensions.rb</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;extensions/action_view&#39;</span>
</span></code></pre></td></tr></table></div></figure>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># action_view.rb</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;extensions/action_view/helpers&#39;</span>
</span></code></pre></td></tr></table></div></figure>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># helpers.rb</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;extensions/action_view/helpers/asset_tag_helper&#39;</span>
</span></code></pre></td></tr></table></div></figure>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># asset_tag_helper.rb</span>
</span><span class='line'><span class="c1"># Overwrite some Asset Tag Helpers to use Sprockets</span>
</span><span class='line'><span class="k">module</span> <span class="nn">ActionView</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Helpers</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Overwrite the javascript_path method to use the &#39;assets&#39; directory</span>
</span><span class='line'>    <span class="c1"># instead of the default &#39;javascripts&#39; (Sprockets will figure it out)</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">javascript_path</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span class='line'>      <span class="n">compute_public_path</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;assets&#39;</span><span class="p">,</span> <span class="s1">&#39;js&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">alias_method</span> <span class="ss">:path_to_javascript</span><span class="p">,</span> <span class="ss">:javascript_path</span> <span class="c1"># aliased to avoid conflicts with a javascript_path named route</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Overwrite the stylesheet_path method to use the &#39;assets&#39; directory</span>
</span><span class='line'>    <span class="c1"># instead of the default &#39;stylesheets&#39; (Sprockets will figure it out)</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">stylesheet_path</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span class='line'>      <span class="n">compute_public_path</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;assets&#39;</span><span class="p">,</span> <span class="s1">&#39;css&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">alias_method</span> <span class="ss">:path_to_stylesheet</span><span class="p">,</span> <span class="ss">:stylesheet_path</span> <span class="c1"># aliased to avoid conflicts with a stylesheet_path named route</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>    <span class="c1"># Check for a sprockets version of the asset, otherwise use the default rails behaviour.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">rewrite_asset_path</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span class='line'>      <span class="n">manifest</span> <span class="o">=</span> <span class="no">Sprockets</span><span class="o">.</span><span class="n">manifest</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="n">manifest</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
</span><span class='line'>        <span class="n">manifest</span><span class="o">.</span><span class="n">assets</span><span class="o">[</span><span class="n">source</span><span class="o">.</span><span class="n">to_s</span><span class="o">]</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="k">super</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>
<p>
  Phew! Now that we&#8217;ve monkey patched the Rails
  <code>AssetTagHelper</code>
  to play nicely with Sprockets, we can do things like this:
</p>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># ERB</span>
</span><span class='line'><span class="o">&lt;</span><span class="sx">%= javascript_include_tag &#39;application&#39; %&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sx"># HAML</span>
</span><span class='line'><span class="sx">=</span> <span class="n">javascript_include_tag</span> <span class="s1">&#39;application&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># =&gt; &lt;link href=&#39;/assets/application.css&#39; media=&#39;screen&#39; rel=&#39;stylesheet&#39; type=&#39;text/css&#39; /&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<p>
  At this point, we&#8217;ve tacked two of the three main objectives; installing Sprockets and the
  asset helpers.  Now we need to talk about precompiling.
</p>
<p>
  We&#8217;ve actually done most of the setup for precompiling already. I took a look at the Rails
  <code><a href='https://github.com/rails/rails/blob/3-2-stable/actionpack/lib/sprockets/assets.rake'>assets.rake</a></code>
  file and copied most of it to create my own:
</p>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># lib/tasks/assets.rake</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;fileutils&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;pathname&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:assets</span> <span class="k">do</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">ruby_rake_task</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="nb">fork</span> <span class="o">=</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'>    <span class="n">env</span>    <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;RAILS_ENV&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="s1">&#39;production&#39;</span>
</span><span class='line'>    <span class="n">groups</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;RAILS_GROUPS&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="s1">&#39;assets&#39;</span>
</span><span class='line'>    <span class="n">args</span>   <span class="o">=</span> <span class="o">[</span><span class="vg">$0</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="s2">&quot;RAILS_ENV=&quot;</span> <span class="o">+</span> <span class="n">env</span><span class="p">,</span> <span class="s2">&quot;RAILS_GROUPS=&quot;</span> <span class="o">+</span> <span class="n">groups</span><span class="o">]</span>
</span><span class='line'>    <span class="n">args</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;--trace&quot;</span> <span class="k">if</span> <span class="no">Rake</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">trace</span>
</span><span class='line'>    <span class="k">if</span> <span class="vg">$0</span> <span class="o">=~</span> <span class="sr">/rake\.bat\Z/i</span>
</span><span class='line'>      <span class="no">Kernel</span><span class="o">.</span><span class="n">exec</span> <span class="vg">$0</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="nb">fork</span> <span class="p">?</span> <span class="n">ruby</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="p">:</span> <span class="no">Kernel</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="no">FileUtils</span><span class="o">::</span><span class="no">RUBY</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># We are currently running with no explicit bundler group</span>
</span><span class='line'>  <span class="c1"># and/or no explicit environment - we have to reinvoke rake to</span>
</span><span class='line'>  <span class="c1"># execute this task.</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">invoke_or_reboot_rake_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;RAILS_GROUPS&#39;</span><span class="o">].</span><span class="n">to_s</span><span class="o">.</span><span class="n">empty?</span> <span class="o">||</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;RAILS_ENV&#39;</span><span class="o">].</span><span class="n">to_s</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>      <span class="n">ruby_rake_task</span> <span class="n">task</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="o">[</span><span class="n">task</span><span class="o">].</span><span class="n">invoke</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;Compile all the assets named in config.assets.precompile&quot;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:precompile</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">invoke_or_reboot_rake_task</span> <span class="s2">&quot;assets:precompile:all&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">namespace</span> <span class="ss">:precompile</span> <span class="k">do</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">internal_precompile</span><span class="p">(</span><span class="n">digest</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Ensure that action view is loaded and the appropriate</span>
</span><span class='line'>      <span class="c1"># sprockets hooks get executed</span>
</span><span class='line'>      <span class="n">_</span> <span class="o">=</span> <span class="no">ActionView</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">sprockets</span> <span class="o">=</span> <span class="no">Sprockets</span><span class="o">.</span><span class="n">env</span>
</span><span class='line'>      <span class="n">manifest_path</span> <span class="o">=</span> <span class="no">Pathname</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">public_path</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;assets&quot;</span><span class="p">,</span> <span class="s2">&quot;manifest.json&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">manifest</span> <span class="o">=</span> <span class="no">Sprockets</span><span class="o">.</span><span class="n">manifest</span>
</span><span class='line'>      <span class="n">manifest</span><span class="o">.</span><span class="n">compile</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">task</span> <span class="ss">:all</span> <span class="k">do</span>
</span><span class='line'>      <span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="o">[</span><span class="s2">&quot;assets:precompile:primary&quot;</span><span class="o">].</span><span class="n">invoke</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">task</span> <span class="ss">:primary</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;assets:environment&quot;</span><span class="p">,</span> <span class="s2">&quot;tmp:cache:clear&quot;</span><span class="o">]</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">internal_precompile</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">task</span> <span class="ss">:nondigest</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;assets:environment&quot;</span><span class="p">,</span> <span class="s2">&quot;tmp:cache:clear&quot;</span><span class="o">]</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">internal_precompile</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;Remove compiled assets&quot;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:clean</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">invoke_or_reboot_rake_task</span> <span class="s2">&quot;assets:clean:all&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">namespace</span> <span class="ss">:clean</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">task</span> <span class="ss">:all</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;assets:environment&quot;</span><span class="p">,</span> <span class="s2">&quot;tmp:cache:clear&quot;</span><span class="o">]</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">public_asset_path</span> <span class="o">=</span> <span class="no">Pathname</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">public_path</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;assets&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">rm_rf</span> <span class="n">public_asset_path</span><span class="p">,</span> <span class="ss">:secure</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:environment</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="o">[</span><span class="s2">&quot;environment&quot;</span><span class="o">].</span><span class="n">invoke</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>
<p>
  That&#8217;s a lot of code to give use two rake tasks;
  <code>rake assets:precompile</code>
  and
  <code>rake assets:clean</code>
  Keep in mind both of those tasks will run in
  <code>'production'</code>
  by default (because that&#8217;s generally the only place you want compiled assets).
</p>
<p>
  The first task,
  <code>rake assets:precompile</code>
  will generate all of your compiled assets in
  <code>/public/assets</code>
  including a manifest file,
  <code>manifest.json</code>
  which contains the mapping from uncompiled asset to precompiled asset.
</p>
<p>
  The second task,
  <code>rake assets:clean</code>
  will delete all of your precompiled assets.
</p>
<p>
  That&#8217;s it! You should now be ready to use Sprockets with Rails 2.3.
</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn"><a href="/about" title="About the author (Jared McFarland)" rel="author">Jared McFarland</a></span></span>

      








  


<time datetime="2012-05-16T10:33:00-07:00" pubdate data-updated="true">May 16<span>th</span>, 2012</time>
      


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/03/05/serving-a-static-website-with-heroku/" title="Previous Post: Serving a static website with Heroku">&laquo; Serving a static website with Heroku</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Jared McFarland -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <span class="credit">Theme by <a href="http://aron.cedercrantz.com/">Aron Cedercrantz</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'jaredmcfarland';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://jaredonline.github.com/blog/2012/05/16/sprockets-2-with-rails-2-dot-3/';
        var disqus_url = 'http://jaredonline.github.com/blog/2012/05/16/sprockets-2-with-rails-2-dot-3/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
